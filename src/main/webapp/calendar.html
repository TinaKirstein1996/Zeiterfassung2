<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Zeiterfassungs Kalender</title>

<link rel="stylesheet" href = "css/calendarStyle.css">
<link rel="stylesheet" href = "js/fullcalendar/lib/main.css">

<script src="js/sweetalert2.all.min.js" defer></script>
<script src="js/fullcalendar/lib/main.js" defer></script>
<script src="js/timeselect.js" defer></script>
	
<script> 
document.addEventListener('DOMContentLoaded', function() {
	var calendarEl = document.getElementById('calendar');
	var calendar = new FullCalendar.Calendar(calendarEl, {
		initialView: 'dayGridMonth',
		height: 650,
		events: 'fetchEvents.php',
		
		selectable: true,
		select: async function (start, end, allDay) {
			const { value: formValues } = await Swal.fire({
				title: 'Arbeitszeit erfassen',
				html: 'Beginn: <input id="swalEvtStart" class="swal2-input" placeholder="Beginn eintragen" type="time">' + 
				'<br>'+
				'Ende: <input id = "swalEvtEnd" class="swal2-input" placeholder="Ende eintragen" type="time">' +
				'<br>'+
				'Pause: <input id = "swalEvtPause" class="swal2-input" placeholder="Pause eintragen" type="time">' +
				'<br>'+
				'Notiz: <input id = "swalEvtNote" class="swal2-input" placeholder="Notiz eintragen">'
				'<br>'+
				//<!-- Tabelle Zeiteingabe -->
				
				'<form action="data_management.php" method="POST"><div hidden="hidden">'+
				'<br>'+
				'<output id="current_date2" name="current_date"></output></div><p class="fallbackLabel"></p><div class="fallbackTimePicker"><div>'+
				'<br>'+
				//<!-- Start -->
				'Beginn:<label for="hour_start"></label><select id="hour_start" name="hour_start"></select><label for="minute_start">:</label><select id="minute_start" name="minute_start"></select>'+
				'<br>'+
				//<!-- Ende -->
				'Ende:<label for="hour_end"></label><select id="hour_end" name="hour_end"></select><label for="minute_end">:</label><select id="minute_end" name="minute_end"></select>'+
				'<br>'+
				//<!-- Pause -->
				'Pause:<label for="hour_pause"></label><select id="hour_pause" name="hour_pause"></select><label for="minute_pause">:</label><select id="minute_pause" name="max_pause"></select>'+
				'<br>'+
				//<!-- Notizen -->
				'Notiz: <input id = "swalEvtNote" class="swal2-input" placeholder="Notiz eintragen">'+
				'<br>'+
				 //<!-- Senden -->
				'<button  id="submitButtonTest" style="width:auto;" >Eingabe speichern</button></div></div>'+
				'<br>'+
				'</form>',
				
				focusConfirm: false,
				preConfirm: () => {
					return [
						document.getElementById('swalEvtStart').value,
						document.getElementById('swalEvtEnd').value,
						document.getElementById('swalEvtPause').value,
						document.getElementById('swalEvtNote').value
					]
				}
				
			});
			
			if (formValues) {
				fetch("eventHandler.php", {
					method: "POST",
					headers: {"Content-Type": "application/json" },
					body: JSON.stringify({ request_type:'addEvent', start:start.startStr, end:start.endStr, 
					event_data: formValues}),
				})
				.then(response => response.json())
				.then(data => {
					if (data.status == 1) {
						Swal.fire('Arbeitszeit erfolgreich erfasst!', '', 'success');
					} else {
						Swal.fire(data.error, '', 'error');
					}
					
					calendar.refetchEvents();
				})
				.catch(console.error);
			}
		},
		
		eventClick: function(info) {
			info.jsEvent.preventDefault();
			
			info.el.style.borderColor = 'red';
			
			Swal.fire({
				title: 'Arbeitszeiterfassung',
				icon: 'info',
				html:'<p> Beginn: '+info.event.extendedProps.start_time+'<br> Ende: '+info.event.extendedProps.end_time+'<br> Pause: '+info.event.extendedProps.pause_time+'<br> Notiz: '+info.event.extendedProps.note+'<br> Geleistete Stunden: '+info.event.extendedProps.working_hours,
				showCloseButton: true,
				showCancelButton: true,
				cancelButtonText: 'Schließen',
				confirmButtonText: 'Erfasste Zeit löschen',
			}).then((result) => {
				if (result.isConfirmed) {
					fetch("eventHandler.php", {
						method: "POST",
						headers: {"Content-Type": "application/json" },
						body: JSON.stringify({ request_type:'deleteEvent', event_id: info.event.id}),
					})
					.then(response => response.json())
					.then(data => {
						if (data.status == 1) {
							Swal.fire('Arbeitszeit erfolgreich gelöscht!', '', 'success');
						} else {
							Swal.fire(data.error, '', 'error');
						}
						
						calendar.refetchEvents();
					})
					.catch(console.error);
				} else {
					swal.close();
				}
			});
			
		}
	});
	calendar.render();
});
</script>
</head>

<body>

<!-- Test Zeit -->
		<!-- Tabelle Zeiteingabe -->	
		
		    	<form action="data_management.php" method="POST"> 
		    	<div hidden="hidden">
		    		<output id="current_date2" name="current_date"></output>
		    	</div>       
           
              	<p class="fallbackLabel">
              	</p>
              	<div class="fallbackTimePicker">
                	<div>
        				<!-- Start -->
                    			<label for="hour_start">Beginn:</label>
                    			<select id="hour_start" name="hour_start"></select> 
                    			<label for="minute_start">:</label>
                    			<select id="minute_start" name="minute_start"></select>
         				<!-- Pause -->
                    			<label for="hour_pause">Pause:</label>
                    			<select id="hour_pause" name="hour_pause"></select>
                    			<label for="minute_pause">:</label>
                    			<select id="minute_pause" name="max_pause"></select>                    
        				<!-- Ende -->
		        		    	<label for="hour_end">Ende:</label> 
                    			<select id="hour_end" name="hour_end"></select>
                    			<label for="minute_end">:</label>
                    			<select id="minute_end" name="minute_end"></select>
        				<!-- Notizen -->
		        			<input type="text" size="14" name="note">
       				 <!-- Senden -->
		        			<button  id="submitButtonTest" style="width:auto;" >Eingabe speichern</button>

		      		</div>
		      	</div>
		      	</form>
<!-- Test Zeit -->

<div class = "container">
	<div class= "wrapper">
		<div id= "calendar"></div>
	</div>
</div>
</body>
</html>
